# Task 1.1.1: Type Definitions & Sun Drop Service

**Status:** Completed
**Phase:** A (Core Mechanics)
**Dependencies:** None
**Estimated Time:** 2-3 hours

---

## Objective

Define all new TypeScript types for the game system and create the Sun Drop service that manages the currency/reward calculations. This task establishes the foundation for all subsequent game mechanics.

---

## Deliverables

### Files to Create
- `src/services/sunDropService.ts` â€” Sun Drop calculation logic
- `src/types/game.ts` â€” Game-specific type definitions

### Files to Modify
- `types.ts` â€” Import and re-export new game types

---

## Type Definitions

### New Enums

```typescript
// src/types/game.ts

/**
 * Activity types for lessons.
 * Each type has different difficulty and Sun Drop values.
 */
export enum ActivityType {
  MULTIPLE_CHOICE = 'multiple_choice',
  FILL_BLANK = 'fill_blank',
  WORD_ARRANGE = 'word_arrange',
  TRUE_FALSE = 'true_false',
  MATCHING = 'matching',
  TRANSLATE = 'translate',
  // Phase 2:
  // LISTEN_TYPE = 'listen_type',
  // SPEAK = 'speak',
}

/**
 * Status of a lesson in a skill path.
 */
export enum LessonStatus {
  LOCKED = 'locked',
  CURRENT = 'current',
  COMPLETED = 'completed',
}

/**
 * Status of a tree in the garden.
 */
export enum TreeStatus {
  SEED = 'seed',       // Just planted, no lessons done
  GROWING = 'growing', // Some lessons completed
  BLOOMED = 'bloomed', // All lessons completed
}

/**
 * Types of gifts players can send to friends.
 */
export enum GiftType {
  WATER_DROP = 'water_drop',   // +10 days buffer on decay
  SPARKLE = 'sparkle',         // Cosmetic + small health boost
  SEED = 'seed',               // Start a new skill path
  RIBBON = 'ribbon',           // Tree decoration
  GOLDEN_FLOWER = 'golden_flower', // Rare garden decoration
}
```

### Core Interfaces

```typescript
/**
 * Configuration for a single activity within a lesson.
 */
export interface ActivityConfig {
  type: ActivityType;
  question?: string;           // For MC, TF
  options?: string[];          // For MC (4 options)
  correctIndex?: number;       // For MC
  correctAnswer?: string;      // For FB, TF
  sentence?: string;           // For FB (with ___ placeholder)
  hint?: string;               // Shown below question
  targetSentence?: string;     // For WA
  scrambledWords?: string[];   // For WA
  isTrue?: boolean;            // For TF
  statement?: string;          // For TF (alternative to question)
  pairs?: Array<{ left: string; right: string }>; // For matching
  sourcePhrase?: string;       // For translate
  acceptedAnswers?: string[];  // For translate
  sunDrops: number;            // 1-4, set by AI based on difficulty
}

/**
 * A single step in a lesson.
 * Each step has tutor text (Professor Finch) and an activity.
 */
export interface LessonStep {
  tutorText: string;    // 1-2 sentences framing the activity
  helpText: string;     // Hint shown when child taps "Help"
  activity: ActivityConfig;
}

/**
 * Full lesson plan generated by AI.
 */
export interface LessonPlan {
  id: string;
  title: string;
  icon: string;
  skillPathId: string;
  lessonIndex: number;
  steps: LessonStep[];
  totalSunDrops: number;  // Sum of all step activity sunDrops
}

/**
 * Definition of a skill path (e.g., "Sports Talk").
 */
export interface SkillPath {
  id: string;
  name: string;
  icon: string;
  description: string;
  category: string;
  lessons: SkillPathLesson[];
}

/**
 * A lesson within a skill path.
 */
export interface SkillPathLesson {
  id: string;
  title: string;
  icon: string;
  status: LessonStatus;
  stars: number;           // 0-3, based on Sun Drops earned
  sunDropsEarned: number;
  sunDropsMax: number;
  completedDate?: string;  // ISO date
}

/**
 * User's tree instance in their garden.
 */
export interface UserTree {
  id: string;
  skillPathId: string;
  name: string;
  icon: string;
  status: TreeStatus;
  health: number;          // 0-100
  lastRefreshDate: string; // ISO date
  sunDropsTotal: number;
  lessonsCompleted: number;
  lessonsTotal: number;
  position: { x: number; y: number };
  decorations: string[];
  giftsReceived: GiftItem[];
}

/**
 * A gift received from a friend.
 */
export interface GiftItem {
  id: string;
  type: GiftType;
  fromUserId: string;
  fromUserName: string;
  appliedDate?: string;
}

/**
 * Garden decoration placed by user.
 */
export interface GardenDecoration {
  id: string;
  itemType: string;
  position: { x: number; y: number };
}

/**
 * Player avatar configuration.
 */
export interface PlayerAvatar {
  id: string;
  emoji: string;   // Placeholder until sprites
  name: string;
}

/**
 * Result of a Sun Drop calculation.
 */
export interface SunDropResult {
  earned: number;      // Amount earned this action
  total: number;       // New total
  capped: boolean;     // Hit daily cap?
  treeGrowth: number;  // Fraction of tree growth (0-1)
}

/**
 * Result of completing an activity.
 */
export interface ActivityResult {
  correct: boolean;
  sunDropsEarned: number;
  sunDropsLost: number;
  attempts: number;
  usedHelp: boolean;
}
```

---

## Sun Drop Service

### File: `src/services/sunDropService.ts`

```typescript
/**
 * Sun Drop Service
 * 
 * Manages the Sun Drop currency â€” earning, spending, penalties.
 * Replaces the XP system throughout the app.
 * 
 * @see GAME_DESIGN.md Section 3 for economy rules
 */

/** Maximum Sun Drops a user can earn per day */
const DAILY_CAP = 50;

/**
 * Calculate Sun Drops earned from an activity.
 * Accounts for retries, help usage, and wrong attempts.
 * 
 * @param baseValue - The activity's base Sun Drop value (1-4)
 * @param isRetry - Whether this is a retry attempt
 * @param usedHelp - Whether the user used the help button
 * @param wrongAttempts - Number of wrong answers before correct
 * @returns Net Sun Drops earned (minimum 0)
 */
export function calculateEarned(
  baseValue: number,
  isRetry: boolean,
  usedHelp: boolean,
  wrongAttempts: number
): number {
  // Half value on retry or after help
  let earned = (isRetry || usedHelp) ? Math.ceil(baseValue / 2) : baseValue;
  
  // Subtract wrong attempt penalties (but floor at 0 for this activity)
  earned = Math.max(0, earned - wrongAttempts);
  
  return earned;
}

/**
 * Calculate the penalty for a wrong answer.
 * Always returns 1 (the per-wrong-answer penalty).
 * 
 * @returns Penalty amount (always 1)
 */
export function calculatePenalty(): number {
  return 1;
}

/**
 * Calculate tree health based on days since last refresh.
 * Gifts provide buffer days before decay kicks in.
 * 
 * @param daysSinceRefresh - Days since last lesson on this tree
 * @param giftsApplied - Number of gifts buffering decay
 * @returns Health percentage (0-100)
 * 
 * @see GAME_DESIGN.md Section 6 for decay formula
 */
export function calculateTreeHealth(
  daysSinceRefresh: number,
  giftsApplied: number = 0
): number {
  // Each gift adds ~10 days of buffer
  const buffer = giftsApplied * 10;
  const effectiveDays = Math.max(0, daysSinceRefresh - buffer);
  
  // Decay schedule from GAME_DESIGN.md
  if (effectiveDays <= 2) return 100;
  if (effectiveDays <= 5) return 85;
  if (effectiveDays <= 10) return 60;
  if (effectiveDays <= 14) return 35;
  if (effectiveDays <= 21) return 15;
  return 5;
}

/**
 * Calculate star rating based on Sun Drops earned vs maximum.
 * 
 * @param earned - Sun Drops earned in lesson
 * @param max - Maximum possible Sun Drops
 * @returns Star rating (1-3)
 */
export function calculateStars(earned: number, max: number): number {
  if (max <= 0) return 1;
  
  const percentage = earned / max;
  
  if (percentage >= 0.9) return 3;  // 90%+
  if (percentage >= 0.6) return 2;  // 60-89%
  return 1;                          // <60%
}

/**
 * Check if daily Sun Drop cap has been reached.
 * 
 * @param earnedToday - Sun Drops earned so far today
 * @returns Whether cap is reached
 */
export function isDailyCapReached(earnedToday: number): boolean {
  return earnedToday >= DAILY_CAP;
}

/**
 * Calculate how many Sun Drops can still be earned today.
 * 
 * @param earnedToday - Sun Drops earned so far today
 * @returns Remaining Sun Drops that can be earned
 */
export function remainingDailyAllowance(earnedToday: number): number {
  return Math.max(0, DAILY_CAP - earnedToday);
}

/**
 * Get the tree growth contribution from Sun Drops.
 * Used to animate tree growth in the UI.
 * 
 * @param sunDropsEarned - Sun Drops earned this session
 * @param sunDropsMax - Maximum Sun Drops for this lesson
 * @returns Growth fraction (0-1)
 */
export function calculateTreeGrowth(
  sunDropsEarned: number,
  sunDropsMax: number
): number {
  if (sunDropsMax <= 0) return 0;
  return Math.min(1, sunDropsEarned / sunDropsMax);
}

/**
 * Determine health category for visual display.
 * 
 * @param health - Health percentage (0-100)
 * @returns Health category for styling
 */
export function getHealthCategory(health: number): 'healthy' | 'thirsty' | 'dying' {
  if (health >= 80) return 'healthy';
  if (health >= 40) return 'thirsty';
  return 'dying';
}

/**
 * Get health indicator text for UI display.
 * 
 * @param health - Health percentage (0-100)
 * @returns Display text and emoji
 */
export function getHealthIndicator(health: number): { text: string; emoji: string; color: string } {
  const category = getHealthCategory(health);
  
  switch (category) {
    case 'healthy':
      return { text: 'Healthy', emoji: 'âœ“', color: 'green' };
    case 'thirsty':
      return { text: 'Thirsty', emoji: 'ðŸ’§', color: 'amber' };
    case 'dying':
      return { text: 'Dying!', emoji: 'ðŸ†˜', color: 'red' };
  }
}
```

---

## Testing Checklist

- [x] All types compile without errors
- [x] `calculateEarned()` returns correct values for all combinations
  - [x] Full value on first try
  - [x] Half value on retry
  - [x] Half value after help
  - [x] Penalty subtraction works
  - [x] Floor at 0
- [x] `calculateTreeHealth()` matches GAME_DESIGN.md table
  - [x] 0-2 days = 100%
  - [x] 3-5 days = 85%
  - [x] 6-10 days = 60%
  - [x] 11-14 days = 35%
  - [x] 15-21 days = 15%
  - [x] 22+ days = 5%
  - [x] Gifts add buffer correctly
- [x] `calculateStars()` returns correct ratings
  - [x] 90%+ = 3 stars
  - [x] 60-89% = 2 stars
  - [x] <60% = 1 star
- [x] Daily cap functions work correctly

---

## Confidence Criteria

| Requirement | Status |
|-------------|--------|
| All new types defined | [x] |
| All enums exported | [x] |
| Sun Drop service implemented | [x] |
| Unit tests pass | [x] |
| Matches GAME_DESIGN.md specs | [x] |

---

## Reference

- **GAME_DESIGN.md** â€” Sections 3 (Sun Drops), 5 (Wrong Answer Mechanics), 6 (Spaced Repetition)
- **CLINE_GAME_IMPLEMENTATION.md** â€” Step 1 (New Type Definitions), Step 3 (Sun Drop Service)
- **prototype-v4-final.jsx** â€” `healthFromDays()` function, Sun Drop calculations

---

## Notes for Future Tasks

- The `LessonPlan` interface will be used by the AI Lesson Generator (Task 1.1.9)
- `UserTree` will be stored in Pocketbase (Task 1.1.7)
- `GiftItem` types will be used by the Gift System (Task 1.1.11)
- Phase 2 will add `LISTEN_TYPE` and `SPEAK` activity types